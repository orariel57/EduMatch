<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8">
  <title>EduMatch | ×”×–×× ×ª ×©×™×¢×•×¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>

<script src="js/nav.js"></script>

<body>

  <header>
    <div class="top-bar">
      <a href="index.html">
        <img src="./image/logoEduMatch.png" alt="EduMatch" class="logo-img">
      </a>
      <button class="nav-toggle" aria-label="×¤×ª×— ×ª×¤×¨×™×˜" aria-expanded="false">â˜°</button>

      <nav>
        <ul class="main-nav">
          <li><a href="index.html">×“×£ ×”×‘×™×ª</a></li>
          <li><a href="teachers.html">×—×™×¤×•×© ××•×¨×™×</a></li>
          <li><a href="profile.html">×”×¤×¨×•×¤×™×œ ×©×œ×™</a></li>
        </ul>

        <ul class="auth-nav">
          <li><a href="login.html">×”×ª×—×‘×¨×•×ª/×”×¨×©××”</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>

    <section class="page-header">
      <h1>×”×–×× ×ª ×©×™×¢×•×¨</h1>
      <p>×‘×—×¨×™ ×ª××¨×™×š ×•×©×¢×” ×¤× ×•×™×™× ××¦×œ ×”××•×¨×”, ×•××©×¨×™ ××ª ×”×”×–×× ×”.</p>
    </section>

    <section class="booking-card" id="booking-error" style="display:none;">
      <h2>×œ× × ××¦× ××•×¨×” ×œ×”×–×× ×”</h2>
      <p class="auth-card-desc">×—×–×¨×™ ×œ×¢××•×“ ×—×™×¤×•×© ×”××•×¨×™× ×•×‘×—×¨×™ ××•×¨×” ×“×¨×š ×”×›×¤×ª×•×¨ "×‘×“×•×§ ×–××™× ×•×ª".</p>
      <a class="btn-primary" href="teachers.html">×—×–×¨×” ×œ×—×™×¤×•×© ××•×¨×™×</a>
    </section>

    <section class="booking-card" id="booking-no-availability" style="display:none;">
      <h2>×”××•×¨×” ×¢×“×™×™×Ÿ ×œ× ×”×’×“×™×¨/×” ×–××™× ×•×ª</h2>
      <p class="auth-card-desc">×‘×™× ×ª×™×™× ××™ ××¤×©×¨ ×œ×‘×—×•×¨ ×ª××¨×™×š ×•×©×¢×”. ×‘×§×©×™ ××”××•×¨×” ×œ×¢×“×›×Ÿ ×–××™× ×•×ª ×‘×¤×¨×•×¤×™×œ.</p>
      <a class="btn-primary" href="teachers.html">×—×–×¨×” ×œ×—×™×¤×•×© ××•×¨×™×</a>
    </section>

    <section class="booking-layout" id="booking-layout" style="display:none;">

      <section class="booking-card booking-teacher-card" aria-labelledby="teacher-card-title">
        <h2 id="teacher-card-title">×¤×¨×˜×™ ×”××•×¨×”</h2>

        <div class="booking-teacher-header">
          <div>
            <h3 class="booking-teacher-name" id="teacher-name">â€”</h3>
            <div class="booking-teacher-meta-line">
              <span class="booking-teacher-subject" id="teacher-subject">â€”</span>
              <span class="booking-separator">â€¢</span>
              <span class="booking-teacher-city" id="teacher-city">â€”</span>
            </div>
          </div>
        </div>

        <div class="booking-teacher-extra">
          <div class="booking-lesson-modes" id="teacher-modes"></div>

          <p class="booking-teacher-price">
            ××—×™×¨ ×œ×©×™×¢×•×¨: <strong id="teacher-price">â€”</strong> /
            <span id="lesson-duration-label">â€” ×“×§×•×ª</span>
          </p>
        </div>
      </section>

      <div class="booking-main-columns">

        <section class="booking-card booking-calendar-card" aria-labelledby="calendar-title">
          <h2 id="calendar-title">×‘×—×¨×™ ×ª××¨×™×š</h2>

          <div class="calendar-header">
            <button type="button" class="calendar-nav-btn" id="prev-month" aria-label="×—×•×“×© ×§×•×“×">â€¹</button>

            <div class="calendar-current-month">
              <span id="calendar-month-label"></span>
            </div>

            <button type="button" class="calendar-nav-btn" id="next-month" aria-label="×—×•×“×© ×”×‘×">â€º</button>
          </div>

          <div class="calendar-grid calendar-grid-names">
            <div class="calendar-day-name">×'</div>
            <div class="calendar-day-name">×‘'</div>
            <div class="calendar-day-name">×’'</div>
            <div class="calendar-day-name">×“'</div>
            <div class="calendar-day-name">×”'</div>
            <div class="calendar-day-name">×•'</div>
            <div class="calendar-day-name">×©'</div>
          </div>

          <div id="calendar-days" class="calendar-grid calendar-grid-days"></div>
        </section>

        <section class="booking-card booking-times-card" aria-labelledby="times-title">
          <h2 id="times-title">×‘×—×¨×™ ×©×¢×”</h2>
          <p class="booking-times-hint" id="times-hint">×‘×—×¨×™ ×§×•×“× ×ª××¨×™×š ×‘×™×•××Ÿ ×›×“×™ ×œ×¨××•×ª ×©×¢×•×ª ×–××™× ×•×ª.</p>
          <div id="time-slots" class="time-slots"></div>
        </section>

        <section class="booking-card booking-summary-card" aria-labelledby="summary-title">
          <h2 id="summary-title">×¡×™×›×•× ×”×–×× ×”</h2>

          <div class="booking-summary-row">
            <span class="summary-label">×ª××¨×™×š × ×‘×—×¨:</span>
            <span class="summary-value" id="summary-date">×œ× × ×‘×—×¨</span>
          </div>

          <div class="booking-summary-row">
            <span class="summary-label">×©×¢×” × ×‘×—×¨×ª:</span>
            <span class="summary-value" id="summary-time">×œ× × ×‘×—×¨</span>
          </div>

          <div class="booking-summary-row">
            <span class="summary-label">××•×¤×Ÿ ×”×©×™×¢×•×¨:</span>
            <div class="summary-value" id="summary-mode-box"></div>
          </div>

          <div class="booking-summary-row">
            <span class="summary-label">××©×š ×©×™×¢×•×¨:</span>
            <span class="summary-value" id="summary-duration">â€”</span>
          </div>

          <div class="booking-summary-row">
            <span class="summary-label">××—×™×¨ ×”×©×™×¢×•×¨:</span>
            <span class="summary-value" id="summary-price">â€”</span>
          </div>

          <div class="booking-summary-actions">
            <button type="button" class="btn-primary" id="confirm-booking" disabled>××™×©×•×¨ ×”×–×× ×”</button>
            <a href="teachers.html" class="btn-secondary">×‘×™×˜×•×œ</a>
          </div>
        </section>

      </div>
    </section>
  </main>

  <footer>
    <div class="footer-content">
      <div class="footer-links">
        <a href="privacy.html">××“×™× ×™×•×ª ×¤×¨×˜×™×•×ª</a>
        <a href="terms.html">×ª× ××™ ×©×™××•×©</a>
        <p>Â© 2025 EduMatch ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª.</p>
      </div>
    </div>
  </footer>

  <script>
    function normalize(str) { return (str || "").trim().toLowerCase(); }

    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    function buildModeTags(lessonMode) {
      const box = document.getElementById("teacher-modes");
      box.innerHTML = "";

      const addTag = (mode, label) => {
        const span = document.createElement("span");
        span.className = "lesson-mode-tag";
        span.dataset.mode = mode;
        span.textContent = label;
        box.appendChild(span);
      };

      if (lessonMode === "online") addTag("online", "ğŸ’» ××§×•×•×Ÿ");
      else if (lessonMode === "in-person") addTag("in-person", "ğŸ« ×¤×¨×•× ×˜×œ×™");
      else {
        addTag("online", "ğŸ’» ××§×•×•×Ÿ");
        addTag("in-person", "ğŸ« ×¤×¨×•× ×˜×œ×™");
      }
    }

    function buildModeRadios(lessonMode) {
      const box = document.getElementById("summary-mode-box");
      box.innerHTML = "";

      const mk = (value, label, checked) => {
        const lab = document.createElement("label");
        lab.className = "summary-radio";
        lab.innerHTML = `<input type="radio" name="summary-lesson-mode" value="${value}" ${checked ? "checked" : ""}> ${label}`;
        box.appendChild(lab);
      };

      if (lessonMode === "online") mk("online", "××§×•×•×Ÿ", true);
      else if (lessonMode === "in-person") mk("in-person", "×¤×¨×•× ×˜×œ×™", true);
      else {
        mk("online", "××§×•×•×Ÿ", true);
        mk("in-person", "×¤×¨×•× ×˜×œ×™", false);
      }
    }

    // ===== ×“××• ××•×¨×” + ×“××• ×–××™× ×•×ª (×‘××§×•× DB) =====
    const DEMO_TEACHERS = [
      {
        fullName: "×“× ×” ×œ×•×™",
        email: "dana.levi@example.com",
        city: "×‘××¨ ×©×‘×¢",
        lessonMode: "online",
        duration: 60,
        subjects: [
          { subject: "××ª××˜×™×§×”", price: 120 },
          { subject: "×× ×’×œ×™×ª", price: 110 }
        ],
        availabilityWeekly: {
          sun: { enabled: true, start: "16:00", end: "20:00" },
          mon: { enabled: true, start: "10:00", end: "14:00" },
          tue: { enabled: false, start: "", end: "" },
          wed: { enabled: true, start: "12:00", end: "18:00" },
          thu: { enabled: true, start: "09:00", end: "13:00" },
          fri: { enabled: false, start: "", end: "" },
          sat: { enabled: false, start: "", end: "" }
        }
      },
      {
        fullName: "×™×•××‘ ×›×”×Ÿ",
        email: "yoav.cohen@example.com",
        city: "×ª×œ ××‘×™×‘",
        lessonMode: "in-person",
        duration: 45,
        subjects: [
          { subject: "×¤×™×™×ª×•×Ÿ", price: 180 },
          { subject: "SQL", price: 160 }
        ],
        availabilityWeekly: {
          sun: { enabled: true, start: "17:00", end: "21:00" },
          mon: { enabled: false, start: "", end: "" },
          tue: { enabled: true, start: "09:00", end: "12:00" },
          wed: { enabled: true, start: "15:00", end: "19:00" },
          thu: { enabled: false, start: "", end: "" },
          fri: { enabled: false, start: "", end: "" },
          sat: { enabled: false, start: "", end: "" }
        }
      }
    ];

    // ===== ××™×¤×•×™ Date.getDay() => ××¤×ª×— availability =====
    const dayKeyByGetDay = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];

    function hasAnyAvailability(av) {
      if (!av) return false;
      return Object.values(av).some(v => v && v.enabled);
    }

    function timeToMinutes(t) {
      const [h, m] = (t || "00:00").split(":").map(Number);
      return (h * 60) + (m || 0);
    }

    function minutesToTime(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
    }

    function buildSlotsForDay(availabilityDay, durationMinutes) {
      if (!availabilityDay?.enabled) return [];
      const start = timeToMinutes(availabilityDay.start);
      const end = timeToMinutes(availabilityDay.end);
      const dur = Math.max(1, Number(durationMinutes) || 60);

      if (!availabilityDay.start || !availabilityDay.end) return [];
      if (start >= end) return [];

      const slots = [];
      for (let t = start; t + dur <= end; t += dur) {
        slots.push(minutesToTime(t));
      }
      return slots;
    }

    // ===== State =====
    let currentYear, currentMonth;
    let selectedDate = null;
    let selectedTime = null;

    const monthNamesHebrew = [
      "×™× ×•××¨", "×¤×‘×¨×•××¨", "××¨×¥", "××¤×¨×™×œ", "×××™", "×™×•× ×™",
      "×™×•×œ×™", "××•×’×•×¡×˜", "×¡×¤×˜××‘×¨", "××•×§×˜×•×‘×¨", "× ×•×‘××‘×¨", "×“×¦××‘×¨"
    ];

    // DOM
    const layoutEl = document.getElementById("booking-layout");
    const errorEl = document.getElementById("booking-error");
    const noAvailEl = document.getElementById("booking-no-availability");

    const teacherNameEl = document.getElementById("teacher-name");
    const teacherCityEl = document.getElementById("teacher-city");
    const teacherSubjectEl = document.getElementById("teacher-subject");
    const teacherPriceEl = document.getElementById("teacher-price");
    const durationLabelEl = document.getElementById("lesson-duration-label");

    const calendarMonthLabel = document.getElementById("calendar-month-label");
    const calendarDaysContainer = document.getElementById("calendar-days");
    const timeSlotsContainer = document.getElementById("time-slots");
    const timesHintEl = document.getElementById("times-hint");

    const summaryDateEl = document.getElementById("summary-date");
    const summaryTimeEl = document.getElementById("summary-time");
    const summaryDurationEl = document.getElementById("summary-duration");
    const summaryPriceEl = document.getElementById("summary-price");
    const confirmBtn = document.getElementById("confirm-booking");

    // ===== 1) ×˜×•×¢× ×™× ××•×¨×” ××”-URL (×“××•) =====
    const teacherEmail = getQueryParam("teacher"); // ××•×¤×¦×™×•× ×œ×™
    const requestedSubject = getQueryParam("subject"); // ××•×¤×¦×™×•× ×œ×™

    // ×× ×œ× ××’×™×¢ ××™××™×™×œ â€” × ×™×§×— ××•×¨×” ×¨××©×•×Ÿ ×›×“××• (×›×“×™ ×©×”×¢××•×“ ×ª××™×“ ×™×¢×‘×•×“ ×‘×”×’×©×”)
    const teacher =
      (teacherEmail
        ? DEMO_TEACHERS.find(t => normalize(t.email) === normalize(teacherEmail))
        : null) || DEMO_TEACHERS[0];

    const teacherWeeklyAvailability = teacher?.availabilityWeekly || {};

    if (!teacher) {
      errorEl.style.display = "block";
    } else {
      if (!hasAnyAvailability(teacherWeeklyAvailability)) {
        noAvailEl.style.display = "block";
      } else {
        layoutEl.style.display = "block";

        // ×‘×—×™×¨×ª ××§×¦×•×¢ ×œ×”×¦×’×” (subject ××”-URL ×× ×§×™×™×, ××—×¨×ª ×”×¨××©×•×Ÿ)
        const subjects = teacher.subjects || [];
        let chosen = null;

        if (requestedSubject) {
          chosen = subjects.find(s => normalize(s.subject) === normalize(requestedSubject))
            || subjects.find(s => normalize(s.subject).includes(normalize(requestedSubject)))
            || null;
        }
        if (!chosen) chosen = subjects[0] || { subject: "×œ× ×¦×•×™×Ÿ", price: "â€”" };

        const duration = Number(teacher.duration || 60);

        teacherNameEl.textContent = teacher.fullName || "â€”";
        teacherCityEl.textContent = teacher.city || "×œ× ×¦×•×™×Ÿ";
        teacherSubjectEl.textContent = chosen.subject || "×œ× ×¦×•×™×Ÿ";
        teacherPriceEl.textContent = `${chosen.price ?? "â€”"} ×©"×—`;
        durationLabelEl.textContent = `${duration} ×“×§×•×ª`;

        summaryDurationEl.textContent = `${duration} ×“×§×•×ª`;
        summaryPriceEl.textContent = `${chosen.price ?? "â€”"} ×©"×—`;

        buildModeTags(teacher.lessonMode);
        buildModeRadios(teacher.lessonMode);
        // âœ… ×¢×“×›×•×Ÿ ×ª×¦×•×’×” ×‘×¡×™×›×•× ×œ×¤×™ ××•×¤×Ÿ ×”×©×™×¢×•×¨ ×©× ×‘×—×¨ (×“××•)
        const summaryModeBox = document.getElementById("summary-mode-box");

        // ×™×•×¦×¨×™× ×©×•×¨×ª ×˜×§×¡×˜ ×§×˜× ×” ××ª×—×ª ×œ×¨×“×™×•
        const modeChosenLine = document.createElement("div");
        modeChosenLine.id = "mode-chosen-line";
        modeChosenLine.style.marginTop = "8px";
        modeChosenLine.style.fontSize = "14px";
        modeChosenLine.style.opacity = "0.9";

        function updateModeChosenLine() {
          const picked = document.querySelector('input[name="summary-lesson-mode"]:checked')?.value || "online";
          modeChosenLine.textContent = `× ×‘×—×¨: ${picked === "in-person" ? "×¤×¨×•× ×˜×œ×™" : "××§×•×•×Ÿ"}`;
        }

        // ××•×¡×™×¤×™× ×œ××¡×š ×¨×§ ×¤×¢× ××—×ª
        if (summaryModeBox && !document.getElementById("mode-chosen-line")) {
          summaryModeBox.appendChild(modeChosenLine);
          updateModeChosenLine();

          summaryModeBox.addEventListener("change", updateModeChosenLine);
        }


        initCalendar();
      }
    }

    // ===== 2) ×™×•××Ÿ =====
    function initCalendar() {
      const today = new Date();
      currentYear = today.getFullYear();
      currentMonth = today.getMonth();

      renderCalendar(currentYear, currentMonth);

      document.getElementById("prev-month").addEventListener("click", () => changeMonth(-1));
      document.getElementById("next-month").addEventListener("click", () => changeMonth(1));
    }

    function changeMonth(offset) {
      currentMonth += offset;
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      else if (currentMonth > 11) { currentMonth = 0; currentYear++; }

      selectedDate = null;
      selectedTime = null;
      updateSummary();
      updateConfirmButtonState();
      timeSlotsContainer.innerHTML = "";
      timesHintEl.textContent = "×‘×—×¨×™ ×§×•×“× ×ª××¨×™×š ×‘×™×•××Ÿ ×›×“×™ ×œ×¨××•×ª ×©×¢×•×ª ×–××™× ×•×ª.";

      renderCalendar(currentYear, currentMonth);
    }

    function isTeacherAvailableOnDate(dateObj) {
      const key = dayKeyByGetDay[dateObj.getDay()];
      const dayAvail = teacherWeeklyAvailability?.[key];
      return !!dayAvail?.enabled;
    }

    function renderCalendar(year, month) {
      calendarDaysContainer.innerHTML = "";

      const firstDayOfMonth = new Date(year, month, 1);
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const startDayIndex = firstDayOfMonth.getDay(); // 0=×'

      calendarMonthLabel.textContent = `${monthNamesHebrew[month]} ${year}`;

      for (let i = 0; i < startDayIndex; i++) {
        const blankCell = document.createElement("div");
        blankCell.className = "calendar-day calendar-day--empty";
        calendarDaysContainer.appendChild(blankCell);
      }

      const today = new Date();
      const isSameMonthAsToday = (year === today.getFullYear() && month === today.getMonth());
      const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dayOfWeek = date.getDay();

        const dayCell = document.createElement("button");
        dayCell.type = "button";
        dayCell.classList.add("calendar-day");
        dayCell.textContent = day;

        if (isSameMonthAsToday && day === today.getDate()) {
          dayCell.classList.add("calendar-day--today");
        }

        // ×—×¡×™××•×ª: ×¢×‘×¨ + ×¡×•×¤"×© + ×œ× ×–××™×Ÿ ×œ×¤×™ ×”××•×¨×”
        const startOfCellDate = new Date(year, month, day);

        const isPastDay = startOfCellDate < startOfToday;
        const isWeekend = (dayOfWeek === 5 || dayOfWeek === 6);
        const isUnavailableForTeacher = !isTeacherAvailableOnDate(date);

        const isDisabled = isPastDay || isWeekend || isUnavailableForTeacher;

        if (isDisabled) {
          dayCell.classList.add("calendar-day--disabled");
          dayCell.disabled = true;
        } else {
          dayCell.addEventListener("click", () => onDateSelected(year, month, day));
        }

        if (selectedDate &&
          selectedDate.getFullYear() === year &&
          selectedDate.getMonth() === month &&
          selectedDate.getDate() === day) {
          dayCell.classList.add("calendar-day--selected");
        }

        calendarDaysContainer.appendChild(dayCell);
      }
    }

    function onDateSelected(year, month, day) {
      selectedDate = new Date(year, month, day);
      selectedTime = null;

      document.querySelectorAll(".calendar-day--selected").forEach(el => el.classList.remove("calendar-day--selected"));

      calendarDaysContainer.querySelectorAll(".calendar-day").forEach(cell => {
        if (cell.textContent === String(day) && !cell.classList.contains("calendar-day--disabled")) {
          cell.classList.add("calendar-day--selected");
        }
      });

      summaryDateEl.textContent = `${day} ${monthNamesHebrew[month]} ${year}`;
      summaryTimeEl.textContent = "×œ× × ×‘×—×¨";

      loadTimeSlotsForDate(selectedDate);
      updateConfirmButtonState();
    }

    function loadTimeSlotsForDate(dateObj) {
      timeSlotsContainer.innerHTML = "";

      const key = dayKeyByGetDay[dateObj.getDay()];
      const dayAvail = teacherWeeklyAvailability?.[key];
      const duration = Number(teacher?.duration || 60);

      const slots = buildSlotsForDay(dayAvail, duration);

      if (!slots.length) {
        timesHintEl.textContent = "××™×Ÿ ×©×¢×•×ª ×–××™× ×•×ª ×‘×™×•× ×”×–×”. ×‘×—×¨×™ ×™×•× ××—×¨.";
        return;
      }

      timesHintEl.textContent = "×‘×—×¨×™ ×©×¢×” ×–××™× ×” ××ª×•×š ×”×¨×©×™××”.";

      slots.forEach(timeStr => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "time-slot";
        btn.textContent = timeStr;
        btn.addEventListener("click", () => onTimeSelected(timeStr));
        timeSlotsContainer.appendChild(btn);
      });
    }

    function onTimeSelected(timeStr) {
      selectedTime = timeStr;

      document.querySelectorAll(".time-slot--selected").forEach(el => el.classList.remove("time-slot--selected"));
      document.querySelectorAll(".time-slot").forEach(el => {
        if (el.textContent === timeStr) el.classList.add("time-slot--selected");
      });

      summaryTimeEl.textContent = timeStr;
      updateConfirmButtonState();
    }

    function updateSummary() {
      if (!selectedDate) summaryDateEl.textContent = "×œ× × ×‘×—×¨";
      if (!selectedTime) summaryTimeEl.textContent = "×œ× × ×‘×—×¨";
    }

    function updateConfirmButtonState() {
      confirmBtn.disabled = !(selectedDate && selectedTime);
    }

    // ===== 3) ××™×©×•×¨ ×”×–×× ×” (×“××• ×‘×œ×‘×“) =====
    confirmBtn.addEventListener("click", () => {
      if (!selectedDate || !selectedTime) return;

      const pickedMode = document.querySelector('input[name="summary-lesson-mode"]:checked')?.value || "online";
      const modeLabel = pickedMode === "in-person" ? "×¤×¨×•× ×˜×œ×™" : "××§×•×•×Ÿ";

      alert(
        "×“××• ×‘×œ×‘×“: \n" +
        "×”×–×× ×” × ×©×œ×—×” .\n\n" +
        `××•×¨×”: ${teacher.fullName}\n` +
        `×ª××¨×™×š: ${summaryDateEl.textContent}\n` +
        `×©×¢×”: ${selectedTime}\n` +
        `××•×¤×Ÿ: ${modeLabel}`
      );
    });
  </script>

</body>

</html>